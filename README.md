# STM32F407 Управление светодиодами с помощью конечного автомата

## Обзор

Этот проект реализует конечный автомат (FSM) на микроконтроллере STM32F407 для управления четырьмя светодиодами, подключенными к портам GPIO. Система использует кнопку на выводе GPIO PA0 для циклического переключения между различными состояниями светодиодов.

## Конфигурация оборудования

### Выводы GPIO
- **Вход кнопки**: PA0 (GPIOA Pin 0)
- **Выходы светодиодов**: PD12, PD13, PD14, PD15 (GPIOD Pins 12-15)

### Конфигурация тактирования
- **HSE**: 8 МГц внешний генератор
- **Системные часы**: 168 МГц (через PLL)
- **Делители**: 
  - AHB: Div1
  - APB1: Div4
  - APB2: Div2

## Архитектура системы

### Состояния конечного автомата

Система работает с 6 состояниями:

1. **STARTUP**: Инициализация всех выводов светодиодов в состояние LOW (выключены)
2. **BUTTON_POLL**: Опрос кнопки PA0 на предмет ввода пользователя
3. **LED_TURN_ON_1**: Активация светодиода на PD12
4. **LED_TURN_ON_2**: Активация светодиода на PD13
5. **LED_TURN_ON_3**: Активация светодиода на PD14
6. **LED_TURN_ON_4**: Активация светодиода на PD15

### Переходы между состояниями

```
STARTUP → BUTTON_POLL ↔ LED_TURN_ON_1 → BUTTON_POLL
                    ↔ LED_TURN_ON_2 → BUTTON_POLL
                    ↔ LED_TURN_ON_3 → BUTTON_POLL
                    ↔ LED_TURN_ON_4 → BUTTON_POLL
```

### Коды возврата

- `OK_FSM_1` по `OK_FSM_4`: Успешные переходы между состояниями
- `ERROR_FSM`: Условие ошибки
- `REPEAT_FSM`: Повтор текущего состояния (кнопка не нажата)

## Процесс работы

1. **Запуск питания**: Система переходит в состояние STARTUP, все светодиоды выключаются
2. **Готовность**: Система переходит в BUTTON_POLL и ожидает нажатия кнопки
3. **Ввод пользователя**: Нажатие кнопки на PA0 увеличивает внутренний счетчик
4. **Отображение светодиодов**: Каждое нажатие кнопки переключается на следующий светодиод:
   - 1-е нажатие → PD12 ON (500мс)
   - 2-е нажатие → PD13 ON (500мс)
   - 3-е нажатие → PD14 ON (500мс)
   - 4-е нажатие → PD15 ON (500мс)
   - Счетчик сбрасывается на 0
5. **Цикл**: Возврат к BUTTON_POLL для следующего ввода

## Структура файлов

```
├── Inc/
│   ├── fsm.h                   # Определения FSM и прототипы функций
│   ├── main.h                  # Основной заголовок с включениями HAL
│   ├── stm32f4xx_hal_conf.h    # Конфигурация HAL
│   ├── stm32f4xx_it.h          # Заголовок обработчиков прерываний
├── Src/
│   ├── fsm.c                   # Реализация FSM
│   ├── main.c                  # Точка входа программы
│   ├── stm32f4xx_hal_msp.c     # MSP (Микроконтроллерный пакет поддержки)
│   ├── stm32f4xx_it.c          # Программы обслуживания прерываний
│   ├── syscalls.c              # Системные вызовы для libc
│   ├── sysmem.c                # Управление памятью
│   └── system_stm32f4xx.c      # Инициализация системы
├── Startup/
│   └── startup_stm32f407vgtx.s # ARM код запуска в ассемблере
└── README.md                   # Этот файл
```

## Ключевые детали реализации

### Цикл FSM
Функция `fsm_loop()` непрерывно:
1. Выполняет функцию обработчика текущего состояния
2. Проверяет код возврата в таблице переходов
3. Обновляет состояние на основе совпадающих переходов
4. Повторяется бесконечно

### Подавление дребезга кнопки
Функция `do_button_poll()`:
- Читает состояние GPIO PA0
- Возвращает `REPEAT_FSM` если кнопка не нажата
- Увеличивает счетчик и возвращает соответствующий код OK при нажатии
- Сбрасывает счетчик после 4-го нажатия

### Управление светодиодами
Каждая функция `do_led_turn_X()`:
- Выключает все остальные светодиоды (устанавливает GPIO_PIN_RESET)
- Включает целевой светодиод (устанавливает GPIO_PIN_SET)
- Задерживается на 500мс для отображения
- Возвращает соответствующий код OK

## Питание и производительность

- **Рабочее напряжение**: 3.3В
- **Тактовая частота ядра**: 168 МГц
- **Потребление энергии**: Минимальное (только опрос кнопки)
- **Время отклика**: < 1мс для переходов между состояниями
